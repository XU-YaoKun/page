<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>用WASM写推理引擎</title>
  <meta name='description' content='notes, translations and thoughts'>

  <link rel="canonical" href="https://tonepture.com/WASM/">
  <link rel="alternate" type="application/rss+xml" title="alu - Blogs" href="/feed.xml">

  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css?family=Nunito:400,700" rel="stylesheet">
  <!-- Ionicons -->
  <link href="https://unpkg.com/ionicons@4.2.2/dist/css/ionicons.min.css" rel="stylesheet">



  <style>
  
  /*! normalize.css v8.0.0 | MIT License | github.com/necolas/normalize.css */html{line-height:1.15;-webkit-text-size-adjust:100%}body{margin:0}h1{font-size:2em;margin:0.67em 0}hr{box-sizing:content-box;height:0;overflow:visible}pre{font-family:monospace, monospace;font-size:1em}a{background-color:transparent}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,samp{font-family:monospace, monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-0.25em}sup{top:-0.5em}img{border-style:none}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,input{overflow:visible}button,select{text-transform:none}button,[type="button"],[type="reset"],[type="submit"]{-webkit-appearance:button}button::-moz-focus-inner,[type="button"]::-moz-focus-inner,[type="reset"]::-moz-focus-inner,[type="submit"]::-moz-focus-inner{border-style:none;padding:0}button:-moz-focusring,[type="button"]:-moz-focusring,[type="reset"]:-moz-focusring,[type="submit"]:-moz-focusring{outline:1px dotted ButtonText}fieldset{padding:0.35em 0.75em 0.625em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}progress{vertical-align:baseline}textarea{overflow:auto}[type="checkbox"],[type="radio"]{box-sizing:border-box;padding:0}[type="number"]::-webkit-inner-spin-button,[type="number"]::-webkit-outer-spin-button{height:auto}[type="search"]{-webkit-appearance:textfield;outline-offset:-2px}[type="search"]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}details{display:block}summary{display:list-item}template{display:none}[hidden]{display:none}body,h1,h2,h3,h4,h5,h6,p,blockquote,pre,dl,dd,ol,ul,fieldset,legend,figure,hr{margin:0;padding:0}li>ul,li>ol{margin-bottom:0}table{border-collapse:collapse;border-spacing:0}h1,h2,h3,h4,h5,h6,ul,ol,dl,blockquote,p,address,hr,table,fieldset,figure,pre{margin-bottom:15px}ul,ol,dd{margin-left:15px}.highlight{background:#2C2F36}.highlighter-rouge .highlight{background:#eef}.highlight pre{background-color:#272822}.highlight .hll{background-color:#272822}.highlight .c{color:#75715e}.highlight .err{color:#960050;background-color:#1e0010}.highlight .k{color:#66d9ef}.highlight .l{color:#ae81ff}.highlight .n{color:#f8f8f2}.highlight .o{color:#f92672}.highlight .p{color:#f8f8f2}.highlight .cm{color:#75715e}.highlight .cp{color:#75715e}.highlight .c1{color:#75715e}.highlight .cs{color:#75715e}.highlight .ge{font-style:italic}.highlight .gs{font-weight:bold}.highlight .kc{color:#66d9ef}.highlight .kd{color:#66d9ef}.highlight .kn{color:#f92672}.highlight .kp{color:#66d9ef}.highlight .kr{color:#66d9ef}.highlight .kt{color:#66d9ef}.highlight .ld{color:#e6db74}.highlight .m{color:#ae81ff}.highlight .s{color:#e6db74}.highlight .na{color:#a6e22e}.highlight .nb{color:#f8f8f2}.highlight .nc{color:#a6e22e}.highlight .no{color:#66d9ef}.highlight .nd{color:#a6e22e}.highlight .ni{color:#f8f8f2}.highlight .ne{color:#a6e22e}.highlight .nf{color:#a6e22e}.highlight .nl{color:#f8f8f2}.highlight .nn{color:#f8f8f2}.highlight .nx{color:#a6e22e}.highlight .py{color:#f8f8f2}.highlight .nt{color:#f92672}.highlight .nv{color:#f8f8f2}.highlight .ow{color:#f92672}.highlight .w{color:#f8f8f2}.highlight .mf{color:#ae81ff}.highlight .mh{color:#ae81ff}.highlight .mi{color:#ae81ff}.highlight .mo{color:#ae81ff}.highlight .sb{color:#e6db74}.highlight .sc{color:#e6db74}.highlight .sd{color:#e6db74}.highlight .s2{color:#e6db74}.highlight .se{color:#ae81ff}.highlight .sh{color:#e6db74}.highlight .si{color:#e6db74}.highlight .sx{color:#e6db74}.highlight .sr{color:#e6db74}.highlight .s1{color:#e6db74}.highlight .ss{color:#e6db74}.highlight .bp{color:#f8f8f2}.highlight .vc{color:#f8f8f2}.highlight .vg{color:#f8f8f2}.highlight .vi{color:#f8f8f2}.highlight .il{color:#ae81ff}.highlight .gu{color:#75715e}.highlight .gd{color:#f92672}.highlight .gi{color:#a6e22e}.container{max-width:1200px;padding-left:15px;padding-right:15px;margin:0 auto}.container-full{max-width:100%;padding-left:15px;padding-right:15px;margin:0 auto}.row{display:flex;flex-wrap:wrap;flex:0 1 auto;flex-direction:row;box-sizing:border-box;margin-left:-15px;margin-right:-15px}.col{padding-left:15px;padding-right:15px}[class^="col-"]{flex:auto}.col-0{width:0%}.col-1{width:8.3333333333%}.col-2{width:16.6666666667%}.col-3{width:25%}.col-4{width:33.3333333333%}.col-5{width:41.6666666667%}.col-6{width:50%}.col-7{width:58.3333333333%}.col-8{width:66.6666666667%}.col-9{width:75%}.col-10{width:83.3333333333%}.col-11{width:91.6666666667%}.col-12{width:100%}.push-0{margin-left:0%}.push-1{margin-left:8.3333333333%}.push-2{margin-left:16.6666666667%}.push-3{margin-left:25%}.push-4{margin-left:33.3333333333%}.push-5{margin-left:41.6666666667%}.push-6{margin-left:50%}.push-7{margin-left:58.3333333333%}.push-8{margin-left:66.6666666667%}.push-9{margin-left:75%}.push-10{margin-left:83.3333333333%}.push-11{margin-left:91.6666666667%}.push-12{margin-left:100%}.pull-0{margin-right:0%}.pull-1{margin-right:8.3333333333%}.pull-2{margin-right:16.6666666667%}.pull-3{margin-right:25%}.pull-4{margin-right:33.3333333333%}.pull-5{margin-right:41.6666666667%}.pull-6{margin-right:50%}.pull-7{margin-right:58.3333333333%}.pull-8{margin-right:66.6666666667%}.pull-9{margin-right:75%}.pull-10{margin-right:83.3333333333%}.pull-11{margin-right:91.6666666667%}.pull-12{margin-right:100%}@media (min-width: 768px){.col-t-0{width:0%}.col-t-1{width:8.3333333333%}.col-t-2{width:16.6666666667%}.col-t-3{width:25%}.col-t-4{width:33.3333333333%}.col-t-5{width:41.6666666667%}.col-t-6{width:50%}.col-t-7{width:58.3333333333%}.col-t-8{width:66.6666666667%}.col-t-9{width:75%}.col-t-10{width:83.3333333333%}.col-t-11{width:91.6666666667%}.col-t-12{width:100%}.push-t-0{margin-left:0%}.push-t-1{margin-left:8.3333333333%}.push-t-2{margin-left:16.6666666667%}.push-t-3{margin-left:25%}.push-t-4{margin-left:33.3333333333%}.push-t-5{margin-left:41.6666666667%}.push-t-6{margin-left:50%}.push-t-7{margin-left:58.3333333333%}.push-t-8{margin-left:66.6666666667%}.push-t-9{margin-left:75%}.push-t-10{margin-left:83.3333333333%}.push-t-11{margin-left:91.6666666667%}.push-t-12{margin-left:100%}.pull-t-0{margin-right:0%}.pull-t-1{margin-right:8.3333333333%}.pull-t-2{margin-right:16.6666666667%}.pull-t-3{margin-right:25%}.pull-t-4{margin-right:33.3333333333%}.pull-t-5{margin-right:41.6666666667%}.pull-t-6{margin-right:50%}.pull-t-7{margin-right:58.3333333333%}.pull-t-8{margin-right:66.6666666667%}.pull-t-9{margin-right:75%}.pull-t-10{margin-right:83.3333333333%}.pull-t-11{margin-right:91.6666666667%}.pull-t-12{margin-right:100%}}@media (min-width: 992px){.col-d-0{width:0%}.col-d-1{width:8.3333333333%}.col-d-2{width:16.6666666667%}.col-d-3{width:25%}.col-d-4{width:33.3333333333%}.col-d-5{width:41.6666666667%}.col-d-6{width:50%}.col-d-7{width:58.3333333333%}.col-d-8{width:66.6666666667%}.col-d-9{width:75%}.col-d-10{width:83.3333333333%}.col-d-11{width:91.6666666667%}.col-d-12{width:100%}.push-d-0{margin-left:0%}.push-d-1{margin-left:8.3333333333%}.push-d-2{margin-left:16.6666666667%}.push-d-3{margin-left:25%}.push-d-4{margin-left:33.3333333333%}.push-d-5{margin-left:41.6666666667%}.push-d-6{margin-left:50%}.push-d-7{margin-left:58.3333333333%}.push-d-8{margin-left:66.6666666667%}.push-d-9{margin-left:75%}.push-d-10{margin-left:83.3333333333%}.push-d-11{margin-left:91.6666666667%}.push-d-12{margin-left:100%}.pull-d-0{margin-right:0%}.pull-d-1{margin-right:8.3333333333%}.pull-d-2{margin-right:16.6666666667%}.pull-d-3{margin-right:25%}.pull-d-4{margin-right:33.3333333333%}.pull-d-5{margin-right:41.6666666667%}.pull-d-6{margin-right:50%}.pull-d-7{margin-right:58.3333333333%}.pull-d-8{margin-right:66.6666666667%}.pull-d-9{margin-right:75%}.pull-d-10{margin-right:83.3333333333%}.pull-d-11{margin-right:91.6666666667%}.pull-d-12{margin-right:100%}}@media (min-width: 768px){.col-t-0{width:0%}.col-t-1{width:8.3333333333%}.col-t-2{width:16.6666666667%}.col-t-3{width:25%}.col-t-4{width:33.3333333333%}.col-t-5{width:41.6666666667%}.col-t-6{width:50%}.col-t-7{width:58.3333333333%}.col-t-8{width:66.6666666667%}.col-t-9{width:75%}.col-t-10{width:83.3333333333%}.col-t-11{width:91.6666666667%}.col-t-12{width:100%}.push-t-0{margin-left:0%}.push-t-1{margin-left:8.3333333333%}.push-t-2{margin-left:16.6666666667%}.push-t-3{margin-left:25%}.push-t-4{margin-left:33.3333333333%}.push-t-5{margin-left:41.6666666667%}.push-t-6{margin-left:50%}.push-t-7{margin-left:58.3333333333%}.push-t-8{margin-left:66.6666666667%}.push-t-9{margin-left:75%}.push-t-10{margin-left:83.3333333333%}.push-t-11{margin-left:91.6666666667%}.push-t-12{margin-left:100%}.pull-t-0{margin-right:0%}.pull-t-1{margin-right:8.3333333333%}.pull-t-2{margin-right:16.6666666667%}.pull-t-3{margin-right:25%}.pull-t-4{margin-right:33.3333333333%}.pull-t-5{margin-right:41.6666666667%}.pull-t-6{margin-right:50%}.pull-t-7{margin-right:58.3333333333%}.pull-t-8{margin-right:66.6666666667%}.pull-t-9{margin-right:75%}.pull-t-10{margin-right:83.3333333333%}.pull-t-11{margin-right:91.6666666667%}.pull-t-12{margin-right:100%}}@media (min-width: 992px){.col-d-0{width:0%}.col-d-1{width:8.3333333333%}.col-d-2{width:16.6666666667%}.col-d-3{width:25%}.col-d-4{width:33.3333333333%}.col-d-5{width:41.6666666667%}.col-d-6{width:50%}.col-d-7{width:58.3333333333%}.col-d-8{width:66.6666666667%}.col-d-9{width:75%}.col-d-10{width:83.3333333333%}.col-d-11{width:91.6666666667%}.col-d-12{width:100%}.push-d-0{margin-left:0%}.push-d-1{margin-left:8.3333333333%}.push-d-2{margin-left:16.6666666667%}.push-d-3{margin-left:25%}.push-d-4{margin-left:33.3333333333%}.push-d-5{margin-left:41.6666666667%}.push-d-6{margin-left:50%}.push-d-7{margin-left:58.3333333333%}.push-d-8{margin-left:66.6666666667%}.push-d-9{margin-left:75%}.push-d-10{margin-left:83.3333333333%}.push-d-11{margin-left:91.6666666667%}.push-d-12{margin-left:100%}.pull-d-0{margin-right:0%}.pull-d-1{margin-right:8.3333333333%}.pull-d-2{margin-right:16.6666666667%}.pull-d-3{margin-right:25%}.pull-d-4{margin-right:33.3333333333%}.pull-d-5{margin-right:41.6666666667%}.pull-d-6{margin-right:50%}.pull-d-7{margin-right:58.3333333333%}.pull-d-8{margin-right:66.6666666667%}.pull-d-9{margin-right:75%}.pull-d-10{margin-right:83.3333333333%}.pull-d-11{margin-right:91.6666666667%}.pull-d-12{margin-right:100%}}@media (min-width: 768px){.col-t-0{width:0%}.col-t-1{width:8.3333333333%}.col-t-2{width:16.6666666667%}.col-t-3{width:25%}.col-t-4{width:33.3333333333%}.col-t-5{width:41.6666666667%}.col-t-6{width:50%}.col-t-7{width:58.3333333333%}.col-t-8{width:66.6666666667%}.col-t-9{width:75%}.col-t-10{width:83.3333333333%}.col-t-11{width:91.6666666667%}.col-t-12{width:100%}.push-t-0{margin-left:0%}.push-t-1{margin-left:8.3333333333%}.push-t-2{margin-left:16.6666666667%}.push-t-3{margin-left:25%}.push-t-4{margin-left:33.3333333333%}.push-t-5{margin-left:41.6666666667%}.push-t-6{margin-left:50%}.push-t-7{margin-left:58.3333333333%}.push-t-8{margin-left:66.6666666667%}.push-t-9{margin-left:75%}.push-t-10{margin-left:83.3333333333%}.push-t-11{margin-left:91.6666666667%}.push-t-12{margin-left:100%}.pull-t-0{margin-right:0%}.pull-t-1{margin-right:8.3333333333%}.pull-t-2{margin-right:16.6666666667%}.pull-t-3{margin-right:25%}.pull-t-4{margin-right:33.3333333333%}.pull-t-5{margin-right:41.6666666667%}.pull-t-6{margin-right:50%}.pull-t-7{margin-right:58.3333333333%}.pull-t-8{margin-right:66.6666666667%}.pull-t-9{margin-right:75%}.pull-t-10{margin-right:83.3333333333%}.pull-t-11{margin-right:91.6666666667%}.pull-t-12{margin-right:100%}}@media (min-width: 992px){.col-d-0{width:0%}.col-d-1{width:8.3333333333%}.col-d-2{width:16.6666666667%}.col-d-3{width:25%}.col-d-4{width:33.3333333333%}.col-d-5{width:41.6666666667%}.col-d-6{width:50%}.col-d-7{width:58.3333333333%}.col-d-8{width:66.6666666667%}.col-d-9{width:75%}.col-d-10{width:83.3333333333%}.col-d-11{width:91.6666666667%}.col-d-12{width:100%}.push-d-0{margin-left:0%}.push-d-1{margin-left:8.3333333333%}.push-d-2{margin-left:16.6666666667%}.push-d-3{margin-left:25%}.push-d-4{margin-left:33.3333333333%}.push-d-5{margin-left:41.6666666667%}.push-d-6{margin-left:50%}.push-d-7{margin-left:58.3333333333%}.push-d-8{margin-left:66.6666666667%}.push-d-9{margin-left:75%}.push-d-10{margin-left:83.3333333333%}.push-d-11{margin-left:91.6666666667%}.push-d-12{margin-left:100%}.pull-d-0{margin-right:0%}.pull-d-1{margin-right:8.3333333333%}.pull-d-2{margin-right:16.6666666667%}.pull-d-3{margin-right:25%}.pull-d-4{margin-right:33.3333333333%}.pull-d-5{margin-right:41.6666666667%}.pull-d-6{margin-right:50%}.pull-d-7{margin-right:58.3333333333%}.pull-d-8{margin-right:66.6666666667%}.pull-d-9{margin-right:75%}.pull-d-10{margin-right:83.3333333333%}.pull-d-11{margin-right:91.6666666667%}.pull-d-12{margin-right:100%}}@media (min-width: 992px){.d-hide{display:none !important}.d-show{display:block !important}}*,*::after,*::before{box-sizing:border-box}body{font-family:"Nunito",sans-serif;font-size:16px;line-height:28px;color:#C9D3E7;background:#2C2F36;overflow-x:hidden;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}body input,body textarea{border:#3E4250 1px solid;outline:none}body input:focus:required:invalid,body textarea:focus:required:invalid{border-color:#e02f40}body input:required:valid,body textarea:required:valid{border-color:#34a74e}::placeholder{color:#666}*::selection{color:#fff;background-color:#1ABC9C}h1,h2,h3,h4,h5,h6{line-height:initial}h1{font-size:36px}h2{font-size:28px}h3{font-size:24px}h4{font-size:20px}h5{font-size:18px}h6{font-size:16px}blockquote{padding-left:15px;border-left:3px solid #1ABC9C;font-style:normal}pre{overflow:auto;padding:15px;margin-bottom:0;font-size:14px;white-space:pre-wrap;word-wrap:break-word;word-break:break-all}img{max-width:100%;height:auto;vertical-align:middle}img+em{text-align:center;display:block;margin-top:10px;font-weight:normal;font-size:16px;color:#707890}a{text-decoration:none;color:#1ABC9C;transition:.35s}a:hover{color:#3ee4c4}hr{display:block;height:2px;padding:0;margin:30px 0;line-height:0;border:0;background-color:#3E4250}blockquote{padding:15px 15px 15px 30px;font-size:18px;font-style:normal;border-left:4px solid #1ABC9C}blockquote p{margin-bottom:0}pre{overflow:auto;padding:15px;margin-bottom:0;font-size:14px;white-space:pre-wrap;word-wrap:break-word;word-break:break-all}.table-container{max-width:100%;overflow-x:auto}table{font-size:12px;color:#101010;width:100%;border-width:1px;border-color:#707890;border-collapse:collapse}table th{padding:8px;font-size:16px;text-align:left;border:1px solid #707890;color:#fff;background-color:#1ABC9C}table tr{background-color:#c5f7ed;transition:all .3s ease}table tr:nth-child(even){background-color:#fff}table td{padding:8px;font-size:14px;border:1px solid #707890}table tr:hover{background-color:#fff}.preloader{position:fixed;top:0;left:0;right:0;bottom:0;z-index:999;overflow:hidden;background:#101010}.loader{position:absolute;top:50%;left:50%;transform:translate(-50%, -50%);padding:10px;font-family:'Nunito', sans-serif;font-size:21px;letter-spacing:.5em;text-transform:uppercase;font-weight:700;color:#fff;background:#101010}.loader span{color:#fff;mix-blend-mode:difference}.loader:before{content:'';position:absolute;top:0;left:0;width:60px;height:100%;background:#fff;animation:animate 3s linear infinite}@keyframes animate{0%{left:0}50%{left:calc(100% - 70px)}100%{left:0}}.button{display:inline-block;white-space:nowrap;vertical-align:middle;font:inherit;text-align:center;padding:8px 30px;border-radius:3px;cursor:pointer;transition:.35s}.button--primary{color:#fff;background-color:#1ABC9C}.button--primary:hover{background-color:#117964;color:#fff;transition:.35s}.button--big{display:block;width:100%}.sidebar{margin-bottom:30px}.widget{padding:40px 15px;margin-bottom:30px;background:rgba(35,36,39,0.95);box-shadow:0 9px 18px 0 rgba(0,0,0,0.25)}.widget .widget-title{position:relative;padding-bottom:15px;margin-bottom:20px;font-size:21px;text-align:center}.widget .widget-title:after{content:"";position:absolute;left:50%;bottom:0;transform:translateX(-50%);display:block;width:50px;height:2px;background:#3E4250}.recent-posts{display:flex;flex-wrap:wrap;align-items:center;margin-bottom:15px}.recent-posts:hover .recent-image::before{background:rgba(0,0,0,0.15);transition:all .5s ease}.recent-posts:hover .recent-content .recent-title a{color:#3ee4c4}.recent-posts:last-child{margin-bottom:0}.recent-posts .recent-header{width:100%;margin-bottom:10px;background:#101010}.recent-posts .recent-header.reveal-in .recent-image{opacity:1}.recent-posts .recent-image{position:relative;display:block;width:100%;height:220px;background-size:cover;background-position:center;background-repeat:no-repeat;background-color:#101010;box-shadow:0 9px 18px 0 rgba(0,0,0,0.25);opacity:0;transition:all 1s cubic-bezier(0.6, 0.3, 0, 1)}.recent-posts .recent-image:after{content:"";display:table;padding-top:20%}.recent-posts .recent-image:before{content:"";position:absolute;width:100%;height:100%;transition:all .5s ease}.recent-posts .recent-content{margin:5px 0}.recent-posts .recent-content .recent-title{margin-bottom:0;font-weight:700}.recent-posts .recent-content .recent-title a{font-size:18px;color:#C9D3E7}.recent-posts .recent-content .recent-date{font-size:12px;color:#707890}.social-profiles{text-align:center}.social-profiles .social-profiles-item{display:inline-block;margin:3px}.social-profiles .social-profiles-link{display:inline-block;line-height:16px;padding:8px 10px;border:1px solid #3E4250;border-radius:3px;color:#3E4250}.social-profiles .social-profiles-link:hover{border-color:#1ABC9C;color:#1ABC9C}.social-profiles .social-profiles-link i{font-size:18px}.widget-instagram .instagram-box{text-align:center}.widget-instagram .instagram-box .instagram-grid{margin-bottom:30px}.widget-instagram .instagram-box .instagram-item{width:33.333%;padding:3px;float:left;overflow:hidden}.widget-instagram .instagram-box .instagram-item a{position:relative;display:block}.widget-instagram .instagram-box .instagram-item a:after{content:"";position:absolute;top:0;display:block;height:100%;width:100%;background:rgba(35,36,39,0.3);transition:.35s}.widget-instagram .instagram-box .instagram-item a:hover:after{background:transparent}.widget-instagram .instagram-box .instagram-prof{font-size:14px;color:#3E4250}.widget-instagram .instagram-box .instagram-prof:hover{text-decoration:underline}.widget-newsletter{text-align:center}.widget-newsletter .newsletter-subtitle{margin-bottom:20px;font-size:18px}.widget-newsletter .newsletter-text{max-width:170px;margin:0 auto 30px;font-size:14px;line-height:19px}.widget-newsletter .newsletter-group-top{position:relative}.widget-newsletter .email-icon{position:absolute;top:50%;left:10px;font-size:22px;transform:translateY(-50%);color:rgba(44,47,54,0.4)}.widget-newsletter .newsletter-email,.widget-newsletter .newsletter-button{width:100%;height:50px;border:none;outline:none}.widget-newsletter .newsletter-email{padding:15px 15px 15px 33px}.widget-newsletter .newsletter-button{margin-top:20px;font-size:14px;font-weight:700;cursor:pointer;color:#fff;background:#2C2F36;transition:.35s}.widget-newsletter .newsletter-button:hover{background:#1ABC9C}.tag-list .tag-item{display:inline-block;margin:3px}.tag-list .tag-item:last-child{margin-right:0}.tag-list .tag-item .tag{display:inline-block;padding:5px 15px;font-size:12px;border-radius:3px;color:#C9D3E7;background:#2C2F36}.tag-list .tag-item .tag:hover{color:#fff;background:#1ABC9C}@media only screen and (min-width: 576px){.widget{padding:40px}}@media only screen and (min-width: 768px){.recent-posts .recent-header{margin-bottom:5px}.recent-posts .recent-image{height:120px}.recent-posts .recent-content .recent-title a{font-size:16px}}@media only screen and (min-width: 992px){.recent-posts{flex-wrap:nowrap}.recent-posts .recent-header{width:auto;margin-right:15px}.recent-posts .recent-image{width:110px}}.pagination{margin:20px 0 40px}.pagination .pagination-list{display:flex;align-items:center;text-align:center}.pagination .pagination-list .older-posts,.pagination .pagination-list .previous-posts,.pagination .pagination-list .newer-posts{display:inline-block;flex-grow:1}.pagination .pagination-list .older-posts .older-link,.pagination .pagination-list .older-posts .previous-link,.pagination .pagination-list .older-posts .newer-link,.pagination .pagination-list .previous-posts .older-link,.pagination .pagination-list .previous-posts .previous-link,.pagination .pagination-list .previous-posts .newer-link,.pagination .pagination-list .newer-posts .older-link,.pagination .pagination-list .newer-posts .previous-link,.pagination .pagination-list .newer-posts .newer-link{display:flex;justify-content:center;align-items:center;padding:20px 35px;font-size:14px;line-height:18px;font-weight:bold;color:#C9D3E7;background:rgba(35,36,39,0.95);transition:.35s}.pagination .pagination-list .older-posts .older-link:hover,.pagination .pagination-list .older-posts .previous-link:hover,.pagination .pagination-list .older-posts .newer-link:hover,.pagination .pagination-list .previous-posts .older-link:hover,.pagination .pagination-list .previous-posts .previous-link:hover,.pagination .pagination-list .previous-posts .newer-link:hover,.pagination .pagination-list .newer-posts .older-link:hover,.pagination .pagination-list .newer-posts .previous-link:hover,.pagination .pagination-list .newer-posts .newer-link:hover{background:rgba(28,29,31,0.95)}.pagination .pagination-list .older-link i{margin-left:10px}.pagination .pagination-list .previous-link i,.pagination .pagination-list .newer-link i{margin-right:10px}@media only screen and (min-width: 768px){.pagination{margin:20px 0}}.footer{padding:50px 0;margin-top:30px;background:#101010}.footer-top{display:flex;justify-content:space-between;align-items:center;padding-bottom:15px;margin-bottom:10px;border-bottom:1px solid #3E4250}.footer-top .logo-text{font-size:16px;font-weight:700;line-height:16px;text-transform:uppercase;letter-spacing:5px;color:#C9D3E7}.footer-top .logo-text:hover{color:#707890}.footer-top .top{display:flex;justify-content:center;align-items:center;width:30px;height:30px;border:1px solid #2C2F36;background-color:#2C2F36;color:#C9D3E7;cursor:pointer;transition:.35s;opacity:.5}.footer-top .top:hover{opacity:1}.footer-bottom{display:flex;align-items:center;flex-wrap:wrap}.footer-bottom .copyright{margin-right:60px}.footer-bottom .copyright p{margin-bottom:0;font-size:13px;color:#707890}.footer-bottom .copyright p a{color:#707890}.footer-bottom .copyright p a:hover{color:#1ABC9C}.footer-bottom .footer-social ul li{display:inline-block;margin-left:15px}.footer-bottom .footer-social ul li:first-child{margin-left:0}.footer-bottom .footer-social ul li a{font-size:13px;font-weight:bold;color:#707890;transition:.35s}.footer-bottom .footer-social ul li a:hover{color:#1ABC9C}.header{margin-bottom:50px;background:#101010}.header,.header-box{height:60px}.header-box{display:flex;flex-direction:row;justify-content:space-between;align-items:center}.header-box .logo-title .logo-text{font-size:16px;font-weight:700;line-height:16px;text-transform:uppercase;letter-spacing:5px;color:#C9D3E7}.header-box .logo-title .logo-text:hover{color:#fff}.nav-menu,.search{position:fixed;top:0;left:0;right:0;bottom:0;transform:scale(0.5);z-index:-1;background:#2C2F36;overflow-y:auto;opacity:0}.nav-menu.active,.search.active{transition:all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);transform:scale(1);z-index:10;opacity:1}.menu-list{max-width:750px;width:100%;margin:5% auto 0;padding:15px;list-style:none;overflow-y:auto}.menu-list .menu-item{text-align:center}.menu-list .menu-link{position:relative;font-size:30px;font-weight:700;line-height:60px;color:#C9D3E7}.menu-list .menu-link:before{content:'';position:absolute;left:0;bottom:0;width:100%;height:5px;pointer-events:none;background:#3DDCA1;transform:scale3d(0, 1, 1);transform-origin:100% 50%;transition:transform 0.35s cubic-bezier(0.8, 0, 0.2, 1)}.menu-list .menu-link:hover:before{transform:scale3d(1, 1, 1);transform-origin:0 50%}.search-close-button{margin:0 auto 50px}.menu-close{margin:20% auto 0}.menu-close,.search-close-button{display:flex;justify-content:center;align-items:center;width:40px;height:40px;font-size:40px;border-radius:50%;border:2px solid #707890;color:#707890;transition:all .35s;cursor:pointer}.menu-close:hover,.search-close-button:hover{border-color:#C9D3E7;color:#C9D3E7}.nav-menu .menu-link,.nav-buttons i.ion{transition:color .35s}.nav-menu .menu-link:hover,.nav-buttons i.ion:hover{color:#fff}.nav-buttons i.ion{margin-left:10px;font-size:20px;vertical-align:middle;color:#C9D3E7;cursor:pointer}.nav-buttons i.ion:first-child{margin-left:0}.search-box{max-width:750px;width:100%;margin:10% auto 0;padding:15px;text-align:center}.search-box .search-text{width:100%;height:60px;margin-bottom:30px;text-align:center;font-size:18px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:#c1c1c7;background:#4f505d}.search-box .search-text::placeholder{color:#c1c1c7}.search-results-list{margin:0}.search-results-list .search-item{margin-bottom:15px;list-style:decimal inside;text-align:left;border-bottom:2px solid #323743;white-space:nowrap}.search-results-list .search-item .search-link{display:inline-block;width:100%;padding:15px;font-size:21px;color:#fff;white-space:normal}.search-results-list .search-item .search-link:hover{color:#707890}.search-results-list .search-no-item{font-size:18px;color:#e02f40;list-style:none}.article-first{margin-bottom:30px;background:#101010}.article-first .article-image-first{position:relative;display:flex;align-items:center;min-height:450px;background-size:cover;background-position:center;background-repeat:no-repeat;background-color:#101010;box-shadow:0 9px 18px 0 rgba(0,0,0,0.25)}.article-first .article-image-first:before{content:"";display:table;padding-top:50%}.article-first .article-content-first{padding:20px;color:#C9D3E7}.article-first .article-content-first .article-tag .tag{font-size:12px}.article-first .article-content-first .article-date .date{font-size:12px;color:rgba(201,211,231,0.8)}.article-first .article-content-first .article-title{margin-bottom:20px;font-size:30px;line-height:30px;font-weight:normal}.article-first .article-content-first .article-title a{color:#C9D3E7;transition:.35s}.article-first .article-content-first .article-excerpt{max-width:450px;margin-bottom:30px;font-size:14px;line-height:23px}.article-first .article-content-first .button{font-size:14px;font-weight:700;border:1px solid #c9d3e7;color:#C9D3E7;transition:.35s}.article-first .article-content-first .button:hover{border:1px solid #1ABC9C;background:#1ABC9C;color:#fff}.article{display:flex;margin-bottom:25px}.article:hover .article-image .image-overlay-text{opacity:1}.article:hover .article-image .image-overlay{opacity:.5;width:100%}.article .article-box{padding-bottom:20px;border-bottom:2px solid #3E4250}.article .article-head{background:#101010}.article .article-image{position:relative;display:block;margin-bottom:20px;background-size:cover;background-position:center;background-repeat:no-repeat;background-color:#101010;box-shadow:0 9px 18px 0 rgba(0,0,0,0.25)}.article .article-image:before{content:"";display:table;padding-top:75%}.article .article-image .image-overlay{position:absolute;top:0;right:0;bottom:0;left:0;width:0;height:100%;background-color:rgba(0,0,0,0.8);opacity:0;transition:all 0.4s ease}.article .article-image .image-overlay-text{position:absolute;top:50%;left:50%;font-size:110px;text-align:center;letter-spacing:2px;color:#C9D3E7;transform:translate(-50%, -50%);transition:all 0.4s ease 0.3s;opacity:0}.article .article-content .article-info{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;margin-bottom:5px}.article .article-content .article-info .article-date{font-size:12px;color:rgba(201,211,231,0.8)}.article .article-content .article-info .article-tag .tag{display:inline-block;padding:2px 5px;margin-right:5px;font-size:12px;line-height:18px;font-weight:bold;border:1px solid #1ABC9C;border-radius:3px;text-transform:capitalize;color:#1ABC9C;transition:.35s}.article .article-content .article-info .article-tag .tag:last-child{margin-right:0}.article .article-content .article-info .article-tag .tag:hover{background:#1ABC9C;color:#fff}.article .article-content .article-title{margin-bottom:5px}.article .article-content .article-title a{font-size:24px;color:#C9D3E7}.article .article-content .article-excerpt{margin-bottom:0;font-size:15px;line-height:25px;color:#707890}.article-box{position:relative;overflow:hidden}.article-first .article-image-first,.article-box .article-image{position:relative;opacity:0;transition:all 1s cubic-bezier(0.6, 0.3, 0, 1)}.article-first.reveal-in .article-image-first,.article-box.reveal-in .article-image{opacity:1}@media only screen and (min-width: 576px){.article-first .article-content-first .article-title{font-size:45px;line-height:45px}.article-first .article-content-first .article-excerpt{margin-bottom:50px}.menu-list .menu-link{font-size:50px;line-height:80px}.menu-list .menu-link:before{height:8px}.search-box .search-text{height:80px;margin-bottom:30px;font-size:24px}}@media only screen and (min-width: 768px){.article-first .article-content-first{padding:60px 40px 0}}@media only screen and (min-width: 992px){.nav-menu{position:relative;display:block;transform:none;opacity:1;z-index:10;background:transparent}.nav-menu .menu-list{padding:0;margin:0}.nav-menu .menu-list .menu-item{display:inline-block;margin:0 15px 0 0}.nav-menu .menu-list .menu-item:last-child{margin-right:0}.nav-menu .menu-list .menu-link{font-size:13px;font-weight:700;text-transform:uppercase;line-height:19px}.nav-menu .menu-list .menu-link:before{content:none}.nav-menu .menu-close{display:none}.nav-menu .menu-link,.nav-buttons i.ion{transition:color .35s}.nav-menu .menu-link:hover,.nav-buttons i.ion:hover{color:#fff}}.post{margin-bottom:20px}.post-image-box{background:#101010}.post-image-box.reveal-in .post-image{opacity:1}.post-image{min-height:430px;margin-bottom:30px;background-size:cover;background-position:center;background-repeat:no-repeat;background-color:#101010;box-shadow:0 9px 18px 0 rgba(0,0,0,0.25);position:relative;opacity:0;transition:all 1s cubic-bezier(0.6, 0.3, 0, 1)}.post-image:after{content:"";display:table;width:100%;padding-top:50%}.post-head,.post-content{background:rgba(35,36,39,0.95)}.post-content{padding:40px 15px;box-shadow:0 9px 18px 0 rgba(0,0,0,0.25)}.post-head,.post-body{margin-bottom:20px;border-bottom:1px solid #3E4250}.post-head{padding-bottom:30px}.post-head .post-tag{margin-bottom:20px;text-align:center}.post-head .post-tag .tag{display:inline-block;padding:5px 15px;margin-right:5px;font-size:12px;line-height:18px;font-weight:bold;border:1px solid #1ABC9C;text-transform:capitalize;color:#1ABC9C;transition:.35s}.post-head .post-tag .tag:last-child{margin-right:0}.post-head .post-tag .tag:hover{background:#1ABC9C;color:#fff}.post-head .post-title{font-size:28px;text-align:center;font-weight:normal;line-height:28px;margin-bottom:5px}.post-head .post-date span{font-size:12px}.post-info,.post-info-author{display:flex;justify-content:center;align-items:center;flex-wrap:wrap}.post-info .post-info-author .info-author-avatar{display:inline-block;width:32px;height:32px;margin-right:10px;border-radius:50%;background-position:center;background-size:cover;background-repeat:no-repeat}.post-info .post-info-author .info-author-name,.post-info .post-info-author span{font-size:12px;text-transform:uppercase}.post-info .post-info-author span{margin-right:10px}.post-info .post-info-author .info-author-name{position:relative;padding-right:20px;margin-right:15px;color:#C9D3E7}.post-info .post-info-author .info-author-name:after{content:"";position:absolute;top:50%;right:0;transform:translateY(-50%);display:block;width:2px;height:12px;background:#3E4250}.post-body{padding-bottom:20px}.post-share{padding:10px 0}.post-share .share-item{display:inline-block;padding-right:15px}.post-share .share-item a{color:#3E4250}.post-share .share-item a:hover{color:#1ABC9C}.post-share .share-item a i.ion{font-size:20px}.post-navigation{display:flex;flex-wrap:wrap;margin-top:30px}.prev,.next{flex-basis:100%;padding:15px;background:#26272B}.prev:hover,.next:hover{background:#1f2023}.prev:hover .post-nav-title,.next:hover .post-nav-title{color:#1ABC9C;transition:.35s}.prev .post-nav-arrow,.next .post-nav-arrow{font-size:14px;color:#C9D3E7}.prev .post-nav-title,.next .post-nav-title{font-size:18px;color:#C9D3E7;transition:.35s}.prev{margin-bottom:10px}.prev,.next{text-align:center}.comments{padding:0 15px;background:#232427}@media only screen and (min-width: 576px){.post-content{padding:40px}.post-head .post-title{font-size:43px;line-height:43px;margin-bottom:10px}.post-navigation{display:flex;justify-content:space-between;flex-wrap:nowrap}.prev,.next{flex-basis:48%;padding:20px}.prev .post-nav-title,.next .post-nav-title{font-size:21px}.prev{text-align:left;margin-bottom:0}.next{text-align:right}.comments{padding:0 40px}}.page{margin-bottom:20px}.page-image-box{background:#101010}.page-image-box.reveal-in .page-image{opacity:1}.page-image{min-height:230px;margin-bottom:30px;background-size:cover;background-position:center;background-repeat:no-repeat;background-color:#101010;box-shadow:0 9px 18px 0 rgba(0,0,0,0.25);opacity:0;transition:all 1s cubic-bezier(0.6, 0.3, 0, 1)}.page-image:after{content:"";display:table;width:100%;padding-top:50%}.page-content{padding:40px 15px;box-shadow:0 9px 18px 0 rgba(0,0,0,0.25);background:rgba(35,36,39,0.95)}.page-head{padding-bottom:30px}.page-head .page-title{font-size:28px;text-align:center;font-weight:normal;line-height:28px;margin-bottom:0}.page-head,.page-body{margin-bottom:20px;border-bottom:1px solid #3E4250}.page-body{padding-bottom:20px}@media only screen and (min-width: 576px){.page-content{padding:40px}.page-head .page-title{font-size:43px;line-height:43px;margin-bottom:10px}}.tags-list{display:flex;flex-wrap:wrap;margin:40px 0;padding:0;list-style:none}.tags-list .tags-item{margin:5px}.tags-list .tags-link{display:inline-block;padding:7px 12px;font-size:14px;border-radius:4px;color:#C9D3E7;font-weight:700;background:#2C2F36}.tags-list .tags-link:hover{color:#fff;background:#1ABC9C}.tags-title{margin-bottom:5px}.tags-group{margin-bottom:30px}.text-left{text-align:left}.text-right{text-align:right}.text-center{text-align:center}.text-justify{text-align:justify}.block{display:block}.inline-block{display:inline-block}.inline{display:inline}.vertical-center{display:flex;align-items:center;justify-content:center}.show{display:block !important}.hide{display:none !important}.invisible{visibility:hidden}.float-left{float:left}.float-right{float:right}.no-padding{padding:0}.no-margin{margin:0}.clearfix::after,.clearfix ::before{content:"";display:table;clear:both}.list-reset{list-style-type:none;margin:0;padding:0}.screen-reader-text{clip:rect(1px, 1px, 1px, 1px);height:1px;overflow:hidden;position:absolute !important;width:1px;word-wrap:normal !important}

  </style>
</head>


<body>

  <div class="preloader">
  <div class="loader">
    <span>Loading</span>
  </div>
</div> <!-- /.loader -->
  <header class="header">
  <div class="container">
    <div class="row">
      <div class="col col-12">
        <div class="header-box">
          <div class="logo-title">
            <a href="/" class="logo-text">ALU</a>
          </div>

          <nav class="nav-menu">
            <i class="menu-close ion ion-ios-close"></i>
            <ul class="menu-list">
              <li class="menu-item"><a href="/" class="menu-link">Home</a></li>
              
                
              
                
              
              <li class="menu-item"><a href="/about/" class="menu-link">About</a></li>
              
                
              
                
              
                
              
                
              
              <li class="menu-item"><a href="/resource/" class="menu-link">Resource</a></li>
              
                
              
                
              
                
              
                
              
                
              
              <li class="menu-item"><a href="/timeline/" class="menu-link">Timeline</a></li>
              
                
              
                
              
                
              
                
              
                
              
            </ul>
          </nav>
          <div class="nav-buttons">
            <i class="menu-button d-hide ion ion-ios-menu"></i>
            <i class="search-button ion ion-ios-search"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="search">
    <div class="search-box">
      <i class="search-close-button ion ion-ios-close"></i>
      <label for="js-search-input" class="screen-reader-text"></label>
      <input type="text" id="js-search-input" class="search-text" autocomplete="off" placeholder="Search Something...">
      <ol id="js-results-container" class="search-results-list"></ol>
    </div>
  </div>
</header> <!-- /.header -->


      <div class="container">
	<div class="row">
		<div class="col col-12">
			<div class="post-image-box">
				<div class="post-image" style="background-image: url(/img/house.jpg)"></div>
			</div>
		</div>
	</div>
</div>

<div class="container">
	<div class="row">
		<article class="col col-12 col-t-8 post">
			<div class="post-content">

				<div class="post-head">
					
					<div class="post-tag">
						
						<a href="/tags#Note" class="tag">Note</a>
						
					</div>
					
					<h1 class="post-title">用WASM写推理引擎</h1>
					<div class="post-info">
						<div class="post-info-author">
							<div class="info-author-avatar" style="background-image: url(/img/profile.jpg)"></div>
							<span>by</span>
							<span class="info-author-name">alu</span>
						</div>
						<div class="post-date">
							<span>
								<time datetime="2021-11-04T10:05:55+00:00">Nov 04, 2021</time>
							</span>
						</div>
					</div>
				</div>

				<div class="post-body">
					<h2 id="从js到wasm">从JS到WASM</h2>

<p>在Web的世界里，JavaScript是最主流的语言，没有之一。</p>

<p>简单说JavaScript的特点，1. 动态语言，变量的类型在运行时确定；2. 解释执行，有JIT机制进行运行时优化，但仍然比C、Rust等编译型选手慢。</p>

<p>其他特点，例如灵活、面向对象等，与本文关联不大，这里不做讨论。</p>

<p>因为动态，所以需要在运行时绑定类型，运行速度慢。因为解释执行，没有编译过程中的大量优化，运行速度慢。</p>

<p>但是在Web中，有时候需要进行大量的计算，例如在网页中识别人脸，需要跑一个神经网络模型；例如在网页上做建模，需要大量的数学推导。这时JavaScript的性能就无法满足需求了，用JavaScript写出来的推理引擎或者建模软件，延迟高，用户体验差。</p>

<p>于是有了WASM，也就是WebAssembly。</p>

<blockquote>
  <p><a href="https://webassembly.github.io/">WebAssembly</a> is a low-level, portable bytecode that is designed to be encoded in a compact binary  format and executed at near-native speed in a memory-safe sandbox.</p>
</blockquote>

<p>可以理解为，WebAssembly是一种接近机器层面的字节码，浏览器可以将其转化为机器码并执行。</p>

<p>一般来说，使用高级语言（例如C/C++、Rust）写出来的代码通过某些编译器可以得到WASM代码，也称WASM是这些编译器的target，例如对于C/C++来说，通过Emscripten compiler编译出WASM。<code class="language-plaintext highlighter-rouge">.wasm</code>文件通过JS胶水代码加载进内存并实例化，然后就可以从JS调用WASM实现的逻辑。</p>

<p>对WebAssembly的加载以及执行有兴趣的话，可以参考<a href="https://segmentfault.com/a/1190000040737725">这篇文章</a>，这里不做赘述。</p>

<p>WASM相比JS来说，有两个优势：1. 快，相同的实现逻辑快两到三倍；2. <code class="language-plaintext highlighter-rouge">.wasm</code>文件体积小，结构更紧凑，便于网络传输。</p>

<p>如下图，通过Emscripten编译器将C/C++代码编译成WASM module，然后通过JavaScript胶水代码将WASM module读取到内存中并执行。</p>

<p><img src="/img/how-wasm-works.png" alt="how-wasm-work" /></p>

<h2 id="用wasm写算子">用WASM写算子</h2>

<p>Web端的推理引擎会采用WASM加速，例如TFjs的<a href="https://github.com/tensorflow/tfjs/tree/master/tfjs-backend-wasm">WASM后端</a>。</p>

<p>推理引擎中的算子部分会用C/C++实现，编译成WASM module，待使用时加载。算子的调度部分用JS实现，包括计算图的构建和内存复用等。</p>

<p>给个例子，ReLU算子。</p>

<p>算子的部分用C++完成。</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="cp">#include &lt;emscripten.h&gt;
</span>
<span class="kt">float</span> <span class="nf">__max</span><span class="p">(</span><span class="kt">float</span> <span class="n">a</span><span class="p">,</span> <span class="kt">float</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">&gt;</span> <span class="n">b</span> <span class="o">?</span> <span class="n">a</span> <span class="o">:</span> <span class="n">b</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">extern</span> <span class="s">"C"</span> <span class="p">{</span>

<span class="n">EMSCRIPTEN_KEEPALIVE</span>
<span class="kt">void</span> <span class="n">ReLU</span><span class="p">(</span><span class="kt">float</span> <span class="o">*</span><span class="n">input</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sz</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="n">output</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">sz</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
        <span class="o">*</span><span class="p">(</span><span class="n">input</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">__max</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">output</span><span class="o">++</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="p">}</span></code></pre></figure>

<p>然后用Emscripten编译上述C++代码，target设置为WASM。</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">➜ em++ <span class="nt">-std</span><span class="o">=</span>c++11 relu.cc <span class="nt">-Os</span> <span class="nt">-s</span> <span class="nv">WASM</span><span class="o">=</span>1 <span class="nt">--no-entry</span> <span class="nt">-o</span> relu.wasm</code></pre></figure>

<p>解释一下命令行中的几个参数，<code class="language-plaintext highlighter-rouge">-std</code>：C++代码的标准，这里用<code class="language-plaintext highlighter-rouge">c++11</code>；<code class="language-plaintext highlighter-rouge">-Os</code>：优化等级；<code class="language-plaintext highlighter-rouge">-s WASM=1</code>编译的target设置为WASM；<code class="language-plaintext highlighter-rouge">--no-entry</code>：代码中没有<code class="language-plaintext highlighter-rouge">main</code>函数；<code class="language-plaintext highlighter-rouge">-o relu.wasm</code>：输出文件名。</p>

<p>这样就得到了一个<code class="language-plaintext highlighter-rouge">.wasm</code>文件。</p>

<p>在C++代码中，宏<code class="language-plaintext highlighter-rouge">EMSCRIPTEN_KEEPALIVE</code>，是告诉编译器不要优化删除这个函数。因为ReLU函数没有被C++代码的其他地方用到，编译器会将这一部分代码视为冗余，但实际上这个函数是在C++代码的外部被调用的。</p>

<p>然后是JavaScript代码，为了方便直接在HTML中写JS了，没有用node之类的JS环境。</p>

<figure class="highlight"><pre><code class="language-html" data-lang="html"><span class="c">&lt;!-- relu.html --&gt;</span>
<span class="nt">&lt;script&gt;</span>
    <span class="kd">const</span> <span class="nx">importObject</span> <span class="o">=</span> <span class="p">{</span>
        <span class="na">module</span><span class="p">:</span> <span class="p">{},</span>
        <span class="na">env</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">memory</span><span class="p">:</span> <span class="k">new</span> <span class="nx">WebAssembly</span><span class="p">.</span><span class="nx">Memory</span><span class="p">({</span> <span class="na">initial</span><span class="p">:</span> <span class="mi">256</span><span class="p">,</span> <span class="na">maximum</span><span class="p">:</span> <span class="mi">32768</span><span class="p">,</span> <span class="na">shared</span><span class="p">:</span> <span class="kc">true</span> <span class="p">}),</span>
        <span class="p">}</span>
    <span class="p">};</span>

    <span class="nx">fetch</span><span class="p">(</span><span class="dl">'</span><span class="s1">relu.wasm</span><span class="dl">'</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">response</span> <span class="o">=&gt;</span>
        <span class="nx">response</span><span class="p">.</span><span class="nx">arrayBuffer</span><span class="p">()</span>
    <span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">bytes</span> <span class="o">=&gt;</span>
        <span class="nx">WebAssembly</span><span class="p">.</span><span class="nx">instantiate</span><span class="p">(</span><span class="nx">bytes</span><span class="p">,</span> <span class="nx">importObject</span><span class="p">)</span>
    <span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">results</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">results</span><span class="p">.</span><span class="nx">instance</span><span class="p">.</span><span class="nx">exports</span><span class="p">)</span>
        <span class="kd">const</span> <span class="nx">ReLU</span> <span class="o">=</span> <span class="nx">results</span><span class="p">.</span><span class="nx">instance</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">ReLU</span>
        <span class="kd">const</span> <span class="nx">memory</span> <span class="o">=</span> <span class="nx">results</span><span class="p">.</span><span class="nx">instance</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">memory</span>

        <span class="kd">const</span> <span class="nx">sz</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="kd">const</span> <span class="nx">input</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Float32Array</span><span class="p">(</span><span class="nx">memory</span><span class="p">.</span><span class="nx">buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">sz</span><span class="p">)</span>
        <span class="nx">input</span><span class="p">.</span><span class="kd">set</span><span class="p">([</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="o">-</span><span class="mi">18</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">input</span><span class="p">)</span>

        <span class="kd">const</span> <span class="nx">output</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Float32Array</span><span class="p">(</span><span class="nx">memory</span><span class="p">.</span><span class="nx">buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">sz</span><span class="p">)</span>
        <span class="nx">ReLU</span><span class="p">(</span><span class="nx">input</span><span class="p">.</span><span class="nx">byteOffset</span><span class="p">,</span> <span class="nx">sz</span><span class="p">,</span> <span class="nx">output</span><span class="p">.</span><span class="nx">byteOffset</span><span class="p">)</span>

        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">output</span><span class="p">)</span>
    <span class="p">});</span>
<span class="nt">&lt;/script&gt;</span></code></pre></figure>

<p>这段代码主要有三个值得注意的地方。</p>

<ol>
  <li>初始化WASM module：这里以文件的形式拉取<code class="language-plaintext highlighter-rouge">relu.wasm</code>，然后将返回得到的<code class="language-plaintext highlighter-rouge">arrayBuffer</code>传入初始化WebAssembly的API。这里的WebAssembly是浏览器提供的处理WASM的库，具体可以参考<a href="https://developer.mozilla.org/zh-CN/docs/WebAssembly/Loading_and_running">这里</a>。</li>
  <li>WASM module中的函数存在于<code class="language-plaintext highlighter-rouge">module.instance.exports</code>对象中。</li>
  <li>在初始化的时候传入的<code class="language-plaintext highlighter-rouge">importObject</code>对象中，有一个<code class="language-plaintext highlighter-rouge">env.memory</code>属性，对应设置了一块可供JS和WASM共享的内存，利用这个内存将JS中的数据传入到WASM中，然后在WASM中做处理。</li>
</ol>

<p>用浏览器打开<code class="language-plaintext highlighter-rouge">relu.html</code>，在Terminal中可以看到以下输出</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="o">&gt;</span> Object <span class="o">{</span> memory: WebAssembly.Memory, ReLU: 1<span class="o">()</span>, __indirect_function_table: WebAssembly.Table, _initialize: 0<span class="o">()</span>, __errno_location: 5<span class="o">()</span>, stackSave: 2<span class="o">()</span>, stackRestore: 3<span class="o">()</span>, stackAlloc: 4<span class="o">()</span> <span class="o">}</span>
<span class="o">&gt;</span> Float32Array<span class="o">(</span>5<span class="o">)</span> <span class="o">[</span> <span class="nt">-3</span>, 15, <span class="nt">-18</span>, 4, 2 <span class="o">]</span>
<span class="o">&gt;</span> Float32Array<span class="o">(</span>5<span class="o">)</span> <span class="o">[</span> 0, 15, 0, 4, 2 <span class="o">]</span></code></pre></figure>

<p>输出结果符合预期。</p>

<p>简单来说，用WASM写算子就是，用C/C++（Rust也行）写好算子的实现逻辑，用对应的编译器生成<code class="language-plaintext highlighter-rouge">.wasm</code>文件，在JS代码中加载<code class="language-plaintext highlighter-rouge">.wasm</code>，从WASM module中拿到对应的函数，然后分配共享内存，进行计算。</p>

<h2 id="simd">SIMD</h2>

<p>Single Instruction Multiple Data.</p>

<p>以扩展指令集的方式支持数据并行。</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="cp">#include &lt;wasm_simd128.h&gt;
#include "memory.h"
</span>
<span class="kt">size_t</span> <span class="n">width</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
<span class="kt">float</span> <span class="o">*</span><span class="n">out</span> <span class="o">=</span> <span class="p">(</span><span class="kt">float</span> <span class="o">*</span><span class="p">)</span> <span class="n">malloc</span><span class="p">(</span><span class="n">width</span> <span class="o">*</span> <span class="nf">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">));</span>
<span class="kt">float</span> <span class="o">*</span><span class="n">in0</span> <span class="o">=</span> <span class="p">(</span><span class="kt">float</span> <span class="o">*</span><span class="p">)</span> <span class="n">malloc</span><span class="p">(</span><span class="n">width</span> <span class="o">*</span> <span class="nf">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">));</span>
<span class="kt">float</span> <span class="o">*</span><span class="n">in1</span> <span class="o">=</span> <span class="p">(</span><span class="kt">float</span> <span class="o">*</span><span class="p">)</span> <span class="n">malloc</span><span class="p">(</span><span class="n">width</span> <span class="o">*</span> <span class="nf">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">));</span>

<span class="cm">/* fill in in0 and in1 */</span>

<span class="c1">// scalar</span>
<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">width</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">in0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">in1</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>  
<span class="p">}</span>

<span class="c1">// simd</span>
<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">width</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">const</span> <span class="n">v128_t</span> <span class="n">vecA</span> <span class="o">=</span> <span class="n">wasm_v128_load</span><span class="p">(</span><span class="n">in0</span><span class="p">);</span>
    <span class="k">const</span> <span class="n">v128_t</span> <span class="n">vecB</span> <span class="o">=</span> <span class="n">wasm_v128_load</span><span class="p">(</span><span class="n">in1</span><span class="p">);</span>
    <span class="n">v128_t</span> <span class="n">r</span> <span class="o">=</span> <span class="n">wasm_f32x4_add</span><span class="p">(</span><span class="n">vecA</span><span class="p">,</span> <span class="n">vecB</span><span class="p">);</span>
    <span class="n">wasm_v128_store</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
    
    <span class="n">in0</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">in1</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
    <span class="n">out</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">free</span><span class="p">(</span><span class="n">out</span><span class="p">),</span> <span class="n">free</span><span class="p">(</span><span class="n">in0</span><span class="p">),</span> <span class="n">free</span><span class="p">(</span><span class="n">in1</span><span class="p">);</span></code></pre></figure>

<p>如上，通过引入<code class="language-plaintext highlighter-rouge">wasm_simd128.h</code>这个头文件，可以使用例如<code class="language-plaintext highlighter-rouge">wasm_v128_load</code>、<code class="language-plaintext highlighter-rouge">wasm_f32x4_add</code>这类的<code class="language-plaintext highlighter-rouge">intrinsics</code>函数。每次将四个浮点数加载进寄存器，然后一次性进行四次加法。这样增加了程序的数据吞吐量，提升性能。</p>

<p>更多关于SIMD的信息参考<a href="https://emscripten.org/docs/porting/simd.html">这里</a>。</p>

<p>这里有一个XNNPACK中实现的<a href="https://github.com/google/XNNPACK/blob/0bf8afaa43601ab37407f262c90ec3c02436a600/src/f32-gemm/gen/1x8s4-minmax-wasmsimd-arm.c">GEMM kernel</a>可供参考。</p>

<p>通过引入SIMD可以编写更高性能的WASM算子。编译器有时也会进行相关的优化，例如，对Emscripten开启某些编译选项之后就使编译器开启自动向量化。</p>

<blockquote>
  <p>Emscripten supports the <a href="https://github.com/webassembly/simd/">WebAssembly SIMD proposal</a> when using the WebAssembly LLVM backend. To enable SIMD, pass the  -msimd128 flag at compile time. This will also turn on LLVM’s  autovectorization passes, so no source modifications are necessary to  benefit from SIMD.</p>
</blockquote>

<p><img src="/img/mobilenet-v2-bench.png" alt="mobilenet benchmark" /></p>

<p>TFjs进行的一些实验，比较开启SIMD和利用多线程后推理的性能，可以看到，使用SIMD之后，推理速度快了将近四倍。</p>

<h2 id="多线程">多线程</h2>

<p>一般通过引入线程池的方式使用多线程。</p>

<p>在web中，JavaScript的执行是单线程的，多线程通过web worker的方式实现。对于Emscripten来说，需要加入编译参数<code class="language-plaintext highlighter-rouge">-pthread</code>开启多线程支持，更多信息可以参考<a href="https://emscripten.org/docs/porting/pthreads.html">文档</a>。</p>

<p>使用多线程的形式，是将一个算子的计算进行分块，然后将不同块分配给不同的线程进行计算。例如，一个加法算子，输入维度为[1024]，则可以将数据分成4个输入维度为[256]分配给四个线程计算。</p>

<p>在tfjs中，使用<a href="https://emscripten.org/docs/porting/pthreads.html">pthreadpool</a>这个线程池进行多线程的加速，这个线程池用bazel构建，看到对应的<a href="https://github.com/Maratyszcza/pthreadpool/blob/master/BUILD.bazel">构建脚本</a></p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">linkopts <span class="o">=</span> <span class="k">select</span><span class="o">({</span>
        <span class="s2">":emscripten_with_threads"</span>: <span class="o">[</span>
            <span class="s2">"-s ALLOW_BLOCKING_ON_MAIN_THREAD=1"</span>,
            <span class="s2">"-s PTHREAD_POOL_SIZE=8"</span>,
        <span class="o">]</span>,
        <span class="s2">"//conditions:default"</span>: <span class="o">[]</span>,
    <span class="o">})</span></code></pre></figure>

<p>可以发现TFjs允许阻塞主线程，并且采用了一个有八个线程的线程池。</p>

<h2 id="misc">Misc</h2>

<ol>
  <li>初始化wasm module时，通过设置传入的importObject，可以向WASM中传入JS的函数，也就是可以从WASM中调用JS。</li>
  <li><code class="language-plaintext highlighter-rouge">relu.html</code>运行时可能遇到CORS的问题，需要配置浏览器的安全选项绕过。</li>
  <li>Chrome开启多线程的时候会遇到SharedArrayBuffer被禁止使用的问题，需要配置服务器的header绕过。</li>
</ol>

				</div>

				<div class="post-navigation">
					
					<a href="/SpiderMonkey/" class="prev">
						<div class="post-nav-arrow"><i class="ion ion-ios-arrow-round-back"></i> Previous Article</div>
						<h2 class="post-nav-title">Spider Monkey</h2>
					</a>
					 
					<a href="/LinkLoadLibrary/" class="next">
						<div class="post-nav-arrow">Next Article <i class="ion ion-ios-arrow-round-forward"></i></div>
						<h2 class="post-nav-title">链接、加载和库</h2>
					</a>
					
				</div>

			</div>
			
				<div class="comments">
  <div id="disqus_thread" class="article-comments"></div>
  <script>
    (function () {
      var d = document, s = d.createElement('script');
      s.src = '//alu-blog.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>Please enable JavaScript to view the
    <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
  </noscript>
</div> <!-- /.comments -->
			
	</article> <!-- /.post -->

	<div class="col col-12 col-t-4">
		<aside class="sidebar">
  
  
  <div class="widget widget-recent">
    <h3 class="widget-title">Recent Posts</h3>
    
    <div class="recent-posts">
      
      <div class="recent-header">
        <a class="recent-image" href="/SQLite/" style="background-image: url(/img/sqlite.jpg)"></a>
      </div>
      
      <div class="recent-content">
        <h6 class="recent-title"><a href="/SQLite/">SQLite Source Code</a></h6>
        <div class="recent-date">
          <time datetime="2023-04-09T05:49:55+00:00">April 9, 2023</time>
        </div>
      </div>
    </div>
    
    <div class="recent-posts">
      
      <div class="recent-header">
        <a class="recent-image" href="/STLContainer/" style="background-image: url(/img/container.jpg)"></a>
      </div>
      
      <div class="recent-content">
        <h6 class="recent-title"><a href="/STLContainer/">C++ STL Container</a></h6>
        <div class="recent-date">
          <time datetime="2022-05-22T03:06:55+00:00">May 22, 2022</time>
        </div>
      </div>
    </div>
    
    <div class="recent-posts">
      
      <div class="recent-header">
        <a class="recent-image" href="/CppMemoryOrder/" style="background-image: url(/img/order.jpg)"></a>
      </div>
      
      <div class="recent-content">
        <h6 class="recent-title"><a href="/CppMemoryOrder/">C++11 Memory Model and Atomic Type</a></h6>
        <div class="recent-date">
          <time datetime="2022-05-02T10:05:55+00:00">May 2, 2022</time>
        </div>
      </div>
    </div>
    
    <div class="recent-posts">
      
      <div class="recent-header">
        <a class="recent-image" href="/LinkLoadLibrary/" style="background-image: url(/img/pink.jpg)"></a>
      </div>
      
      <div class="recent-content">
        <h6 class="recent-title"><a href="/LinkLoadLibrary/">链接、加载和库</a></h6>
        <div class="recent-date">
          <time datetime="2021-12-15T10:05:55+00:00">December 15, 2021</time>
        </div>
      </div>
    </div>
    
  </div>
  

  <div class="widget widget-social">
    <h3 class="widget-title">Subscribe & Follow</h3>
    <ul class="social-profiles list-reset">
      <li class="social-profiles-item">
        <a href="https://github.com/XU-YaoKun" class="social-profiles-link"><i class="ion ion-logo-github"></i></a>
      </li>

      <li class="social-profiles-item">
        <a href="" class="social-profiles-link"><i class="ion ion-ios-text"></i></a>
      </li>

      <li class="social-profiles-item">
        <a href="" class="social-profiles-link"><i class="ion ion-ios-trending-up"></i></a>
      </li>

      <li class="social-profiles-item">
        <a href="https://unsplash.com/" class="social-profiles-link"><i class="ion ion-ios-images"></i></a>
      </li>
    </ul>
  </div>

  <div class="widget widget-tags">
    <h3 class="widget-title">Tag Cloud</h3>
     
    <ul class="tag-list list-reset">
    
      
        <li class="tag-item"><a href="/tags#Note" class="tag">Note</a></li>
      
    
      
        <li class="tag-item"><a href="/tags#Thoughts" class="tag">Thoughts</a></li>
      
    
      
        <li class="tag-item"><a href="/tags#Translation" class="tag">Translation</a></li>
      
    
    
    </ul>
  </div>
  
</aside> <!-- /.sidebar -->
	</div>

	</div>
</div>

  <footer class="footer">
  <div class="container">
    <div class="row">
      <div class="col col-12">
        <div class="footer-top">
          <h2 class="logo-title">
            <a href="/" class="logo-text">ALU</a>
          </h2>
          <div class="top"><i class="ion ion-ios-arrow-up"></i></div>
        </div>
        <div class="footer-bottom">
          <div class="copyright">
            <p>&copy; 2023 Crafted & Designed by <a href="https://github.com/artemsheludko/galada">Artem Sheludko</a></p>
          </div>
        </div>
      </div>
    </div>
  </div>
</footer> <!-- /.footer -->
  <script src="/js/jquery-3.3.1.min.js"></script>
<script src="/js/simple-jekyll-search.min.js"></script>
<script>
  SimpleJekyllSearch({
  searchInput: document.getElementById("js-search-input"),
  resultsContainer: document.getElementById("js-results-container"),
  json: "/search.json",
  searchResultTemplate:
    '<li class="search-item"><a class="search-link" href="{url}">{title}</a></li>',
  noResultsText: '<li class="search-no-item">No results found</li>'
  });
</script>
<script src="/js/instafeed.min.js"></script>
<script src="/js/jquery.waitforimages.min.js"></script>
<script src="/js/jquery.fitvids.js"></script>
<script src="/js/common.js"></script>


</body>

</html>
